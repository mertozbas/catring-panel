{% extends "base.html" %}
{% block title %}Malzeme Planlama{% endblock %}
{% block page_title %}Malzeme Ä°htiyaÃ§ Planlama{% endblock %}

{% block content %}
<div class="toolbar">
    <div class="toolbar-left">
        <form method="GET" style="display:flex;gap:8px;align-items:end;">
            <div class="form-group" style="margin:0;">
                <label style="font-size:12px;">MenÃ¼ SeÃ§in</label>
                <select name="menu_id" class="form-control" onchange="this.form.submit()">
                    <option value="">MenÃ¼ seÃ§in...</option>
                    {% for m in menus %}
                    <option value="{{ m.id }}" {% if menu_id and menu_id|int == m.id %}selected{% endif %}>{{ m.week_start_date }} HaftasÄ±</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

{% if selected_menu %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_portions }}</div>
        <div class="stat-label">Tahmini GÃ¼nlÃ¼k Porsiyon</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ planning_data|length }}</div>
        <div class="stat-label">Malzeme Ã‡eÅŸidi</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ planning_data|selectattr('to_buy', 'gt', 0)|list|length }}</div>
        <div class="stat-label">SatÄ±n AlÄ±nacak</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>{{ selected_menu.week_start_date }} HaftasÄ± Malzeme Ä°htiyacÄ±</h3>
    </div>
    <div class="card-body">
        {% if planning_data %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Malzeme</th>
                        <th>Birim</th>
                        <th>HaftalÄ±k Ä°htiyaÃ§</th>
                        <th>Mevcut Stok</th>
                        <th>SatÄ±n AlÄ±nacak</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in planning_data %}
                    <tr {% if item.to_buy > 0 %}style="background:#fff3cd;"{% endif %}>
                        <td><strong>{{ item.ingredient_name }}</strong></td>
                        <td>{{ item.unit }}</td>
                        <td>{{ item.needed }}</td>
                        <td>{{ item.current_stock }}</td>
                        <td>
                            {% if item.to_buy > 0 %}
                            <strong style="color:var(--danger);">{{ item.to_buy }}</strong>
                            {% else %}
                            <span style="color:var(--success);">Yeterli</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if planning_data|selectattr('to_buy', 'gt', 0)|list|length > 0 %}
        <div style="margin-top:15px;text-align:right;">
            <form method="POST" action="{{ url_for('planning.generate_purchase') }}" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="menu_id" value="{{ menu_id }}">
                <button type="submit" class="btn btn-primary" onclick="return confirm('Eksik malzemeler iÃ§in satÄ±nalma sipariÅŸi oluÅŸturulsun mu?')">ğŸ›’ SatÄ±nalma SipariÅŸi OluÅŸtur</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <p>Bu menÃ¼ iÃ§in tarif bilgisi bulunamadÄ±. Ã–nce Diyetisyen panelinden tarifleri ekleyin.</p>
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="icon">&#9776;</div>
            <p>Malzeme ihtiyacÄ±nÄ± hesaplamak iÃ§in yukarÄ±dan bir menÃ¼ seÃ§in.</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
